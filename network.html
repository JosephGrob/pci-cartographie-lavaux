<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>R√©seau d'acteurs ‚Äì Lavaux</title>
  <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  <link href="https://unpkg.com/vis-network@9.1.2/styles/vis-network.min.css" rel="stylesheet" type="text/css" />

  <!-- Leaflet pour les cartes dans les noeuds -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    #network {
      width: 100%;
      height: 600px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    #info-panel {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      background-color: #f8f8f8;
      border-radius: 6px;
      max-height: 300px;
      overflow: auto;
    }
    pre {
      font-size: 0.85em;
      background-color: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  
  <h1>R√©seau d'acteurs du savoir-faire √† Lavaux</h1>
  <p>Ce graphe est g√©n√©r√© automatiquement √† partir des r√©ponses enregistr√©es dans Baserow.</p>

  <div id="network"></div>
  <div id="info-panel">Cliquez sur un n≈ìud pour voir les d√©tails</div>

  <script>
    async function buildNetwork() {
      const TOKEN = "oF4ZhbO62oPoeUpVVrbjCuf8s3Jaxe3v";
      const TABLE_ID = "510775";
      const API_URL = `https://api.baserow.io/api/database/rows/table/${TABLE_ID}/?user_field_names=true`;

      const response = await fetch(API_URL, {
        headers: { Authorization: `Token ${TOKEN}` }
      });
      const result = await response.json();
      const rows = result.results;

      const nodesMap = new Map();
      const edges = [];
      const roleLabels = {
        pratique: "pratique",
        etudie: "√©tudie",
        lesdeux: "√©tudie et pratique",
        temoin: "t√©moigne"
      };

      function updateNodeData(node, updates, isAuthor = false) {
        for (const key in updates) {
          const value = updates[key];
          if (!value || typeof value !== "string" || value.trim() === "") continue;

          if (!node.meta[key]) node.meta[key] = [];

          // Supprimer les anciennes valeurs collaboratives si c'est l'auteur qui parle maintenant
          if (isAuthor) {
            // Filtrer toutes les anciennes valeurs (on ne garde que celles aussi marqu√©es comme auteur ou rien du tout)
            node.meta[key] = node.meta[key].filter(item => item.source !== "collab");
          }

          // N'ajouter que si la valeur n'existe pas d√©j√†
          const alreadyExists = node.meta[key].some(item => item.value === value);
          if (!alreadyExists) {
            node.meta[key].push({
              value: value,
              source: isAuthor ? "author" : "collab"
            });
          }
        }
      }


      rows.forEach(row => {
        const author = row.nom?.trim();
        const authorType = row.type;
        const role = row.role;

        // ---- Auteur principal
        if (author) {
          if (!nodesMap.has(author)) {
            nodesMap.set(author, {
              id: author,
              label: author,
              group: authorType,
              meta: {}
            });
          }

          updateNodeData(nodesMap.get(author), {
            type: row.type,
            age: row.age,
            metier: row.metier,
            user_lieu: row.user_lieu,
            memoire: row.memoire,
            evenement: row.evenement
          }, true); // üëà vrai : c‚Äôest l‚Äôauteur qui parle

        }

        // ---- Collaborateur
        const collab = row.collab_nom?.trim();
        const collabType = row.collab_type;


        let dynCollabs = [];

        try {
          if (typeof row.collaborations_dynamiques === "string") {
            dynCollabs = JSON.parse(row.collaborations_dynamiques);
          } else if (Array.isArray(row.collaborations_dynamiques)) {
            dynCollabs = row.collaborations_dynamiques;
          }
        } catch (e) {
          console.warn("‚ùå Impossible de parser collaborations_dynamiques :", e);
        }

        if (Array.isArray(dynCollabs)) {
          dynCollabs.forEach(c => {
            const cName = c.nom?.trim();
            if (!cName) return;

            if (!nodesMap.has(cName)) {
              nodesMap.set(cName, {
                id: cName,
                label: cName,
                group: c.type,
                meta: {}
              });
            }

            updateNodeData(nodesMap.get(cName), {
              type: c.type,
              age: c.age,
              metier: c.metier,
              collab_lieu: c.lieu,
              collab_implication: c.implication,
              annee: c.annee,
              membres: c.membres,
              activites: c.activites,
              nb_personnes: c.nb_personnes,
              liens: c.liens,
              ages_famille: c.ages_famille,
              collab_autre: c.autre
            }, false);

            edges.push({
              from: author,
              to: cName,
              label: "collabore avec",
              title: c.description || "",
              color: { color: "#2c3e50" }
            });
          });
        }



        if (collab) {
          if (!nodesMap.has(collab)) {
            nodesMap.set(collab, {
              id: collab,
              label: collab,
              group: collabType,
              meta: {}
            });
          }

          const extraCollabData = {
            type: collabType,
            age: row.collab_age,
            metier: row.collab_metier,
            collab_lieu: row.collab_lieu,
            collab_implication: row.collab_implication,

            // Ajouts personnalis√©s
            label: collab, // pour afficher le nom comme titre
            annee: row.collab_annee,
            membres: row.collab_membres,
            activites: row.collab_activites,
            nb_personnes: row.collab_nb_personnes,
            liens: row.collab_liens,
            ages_famille: row.collab_ages_famille,
            collab_autre: row.collab_autre
          };

          updateNodeData(nodesMap.get(collab), extraCollabData, false);



          edges.push({
            from: author,
            to: collab,
            label: "collabore avec",
            title: row.collab_description || "",
            color: { color: "#2c3e50" }
          });
        }

        // ---- Zone(s)
        const zones = row.zones_geojson;
        const labelTexte = roleLabels[role] || "a renseign√©";

        if (zones && zones.length > 0 && author) {
          try {
            const geojson = JSON.parse(zones);
            const zoneLabelsByIndex = [
              "a appris (apprend)",        // index 0 = apprentissage
              "a transmis (transmets)",      // index 1 = transmission
              "a pratiqu√© (pratique)",      // index 2 = pratique
              "a √©tudi√© (√©tudie)",        // index 3 = √©tude
              "a des informations"        // index 4 = information (si pr√©sent)
            ];

            geojson.forEach((feature, index) => {
              const zoneId = `${author}-zone-${index}`;

              // üß† On r√©cup√®re le type r√©el de la zone (ajout√© pr√©c√©demment dans le formulaire)
              const zoneType = feature.properties?.zoneType;

              const zoneLabelsByType = {
                apprentissage: "a appris (apprend)",
                transmission: "a transmis (transmet)",
                pratique: "a pratiqu√© (pratique)",
                etudie: "a √©tudi√© (√©tudie)",
                information: "a des informations"
              };

              const edgeLabel = zoneLabelsByType[zoneType] || "li√© √† cette zone";

              nodesMap.set(zoneId, {
                id: zoneId,
                label: "Lieu",
                group: "zone",
                title: "Cliquez pour voir la carte",
                geojson: feature
              });

              edges.push({
                from: author,
                to: zoneId,
                label: edgeLabel,
                dashes: true,
                color: { color: "#e67e22" }
              });
            });

          } catch (e) {
            console.error("‚õî Erreur de parsing GeoJSON :", e);
          }
        }
      });


      function generateCustomDetails(meta, type) {
        const get = key => {
          const list = meta[key];
          if (!list || list.length === 0) return "Non renseign√©";
          return list.map(entry => entry.value).join("<br>");
        };

        switch (type) {
          case "entreprise":
          case "association":
          case "collectif":
          case "commune":
            return `
              <strong>Nom</strong>: ${get("label")}<br>
              <strong>Lieu</strong>: ${get("user_lieu") || get("collab_lieu")}<br>
              <strong>Ann√©e de cr√©ation</strong>: ${get("annee")}<br>
              <strong>Nombre de membres</strong>: ${get("membres")}<br>
              <strong>Type d‚Äôactivit√©s</strong>: ${get("activites")}
            `;

          case "famille":
            return `
              <strong>Nom</strong>: ${get("label")}<br>
              <strong>Lieu</strong>: ${get("user_lieu") || get("collab_lieu")}<br>
              <strong>Nombre de personnes</strong>: ${get("nb_personnes")}<br>
              <strong>Liens entre les personnes</strong>: ${get("liens")}<br>
              <strong>√Çge de chaque personne</strong>: ${get("ages_famille")}
            `;

          case "personne":
            return `
              <strong>√Çge</strong>: ${get("age")}<br>
              <strong>M√©tier</strong>: ${get("metier")}<br>
              <strong>Lieu</strong>: ${get("user_lieu") || get("collab_lieu")}
            `;

          case "autre":
            return `
              <strong>Nom</strong>: ${get("label")}<br>
              <strong>Pr√©cisez</strong>: ${get("collab_autre") || get("autre")}
            `;

          default:
            return `
              <strong>Lieu</strong>: ${get("user_lieu") || get("collab_lieu")}
            `;
        }
      }







      // Cr√©er les noeuds avec les infos combin√©es
      const nodes = Array.from(nodesMap.values()).map(node => {
        const meta = node.meta || {};
        const formatField = key => {
          const list = meta[key];
          if (!list || list.length === 0) return "Non renseign√©";
          return list.map(entry => `${entry.value}`).join("<br>");
        };



        node.title = `
          ${generateCustomDetails(meta, node.group)}<br>
          ${formatField("collab_implication") !== "Non renseign√©" ? `<strong>üí¨ Implication :</strong><br>${formatField("collab_implication")}<br>` : ""}
          ${formatField("memoire") !== "Non renseign√©" ? `<strong>üü¶ Ce que cela signifie pour cette personne :</strong><br>${formatField("memoire")}<br>` : ""}
          ${formatField("evenement") !== "Non renseign√©" ? `<strong>üüß √âvolution observ√©e :</strong><br>${formatField("evenement")}` : ""}
        `;


        return node;
      });

      const container = document.getElementById("network");
      const data = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };

      const options = {
        nodes: {
          shape: "dot",
          size: 15,
          font: {
            size: 14,
            color: "#000000",
            face: "Arial"
          },
          borderWidth: 1
        },
        groups: {
          personne: { color: "#3498db" },
          famille: { color: "#3498db" },
          association: { color: "#3498db" },
          entreprise: { color: "#3498db" },
          collectif: { color: "#3498db" },
          commune: { color: "#3498db" },
          autre: { color: "#3498db" },
          zone: { color: "#f39c12" }
        },

        edges: {
          arrows: "to",
          font: { align: "middle" }
        },
        physics: {
          stabilization: true
        }
      };

      const network = new vis.Network(container, data, options);

      network.on("click", function (params) {
        const panel = document.getElementById("info-panel");

        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const nodeData = nodesMap.get(nodeId);

          if (nodeData.group === "zone" && nodeData.geojson) {
            const geojson = nodeData.geojson;
            panel.innerHTML = `
              <h3>Zone d‚Äô√©tude</h3>
              <div id="mini-map" style="height: 250px; border-radius: 6px; margin-top: 10px;"></div>
            `;
            setTimeout(() => {
              const map = L.map("mini-map").setView([46.5, 6.7], 13);
              L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors"
              }).addTo(map);
              L.geoJSON(geojson, {
                style: { color: "#e67e22", weight: 2 }
              }).addTo(map);
              map.fitBounds(L.geoJSON(geojson).getBounds());
            }, 50);
          } else {
            panel.innerHTML = `
              <h3>${nodeData.label}</h3>
              <p><strong>Type</strong>: ${nodeData.group}</p>
              <p><strong>D√©tails</strong>:<br>${nodeData.title}</p>
            `;
          }

        } else if (params.edges.length > 0) {
          const edgeId = params.edges[0];
          const edgeData = data.edges.get(edgeId);
          panel.innerHTML = `
            <h3>Collaboration</h3>
            <p><strong>Entre</strong> : ${edgeData.from} ‚Üí ${edgeData.to}</p>
            <p><strong>Souvenir ou anecdote :</strong></p>
            <p>${edgeData.title || "Aucune anecdote renseign√©e."}</p>
        `;
        } else {
          panel.innerHTML = "Cliquez sur un n≈ìud ou un lien pour voir les d√©tails";
        }
      });


    }

    buildNetwork();
  </script>

</body>
</html>
